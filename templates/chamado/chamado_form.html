{% extends 'principal.html'%}
{% include "components/combobox.html"%}

{% block title %}Formulario de Chamado{%endblock%}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
{% endblock %}

{% block main %}
<div class="card w-full max-w-3xl shadow-lg bg-base-100">
    <div class="card-body">
        <h2 class="card-title">Formulario de Chamado</h2>

        <form id="form_chamado" class="space-y-4" method="POST" action="{% if row %}/chamado/chamado-form/{{row.id}}{% else %}/chamado/chamado-form{% endif %}">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div class="col-span-2 md:col-span-1 min-w-full">
                    {% if row %}
                    <div class="col-span-2 md:col-span-1">
                        <div class="flex flex-col min-w-full">
                            <label for="id" class="label">ID</label>
                            <input id="id" name="id" type="hidden" value="{{row.id}}" />
                            <input type="text" value="{{row.id}}" class="input input-bordered" disabled />
                            <input id="status" name="status" type="hidden" value="{{row.status}}" />
                        </div>
                    </div>
                    {% endif %}
                    <div class="flex flex-col">
                        <label class="label">
                            <span class="label-text font-semibold">Tipo</span>
                        </label>
                        {% set value_tipo = tipo.id if tipo else '' %}
                        {% set nome_tipo = tipo.nome if tipo else '' %}
                        {{ combobox(
                            field_name="tipo_id",
                            field_label="nome", 
                            placeholder="Selecione o tipo",
                            endpoint="/chamado/tipo-api",
                            attrs="required",
                            search=nome_tipo,
                            value=value_tipo,
                        ) }}
                    </div>
                    <div class="flex flex-col">
                        <label class="label">
                            <span class="label-text font-semibold">Serviço</span>
                        </label>
                        {% set value_servico = servico.id if servico else '' %}
                        {% set nome_servico = servico.nome if servico else '' %}
                        {{ combobox(
                            field_name="servico_id",
                            field_label="nome", 
                            placeholder="Selecione o serviço",
                            endpoint="/chamado/servico-api",
                            attrs="required",
                            search=nome_servico,
                            value=value_servico,
                        ) }}
                    </div>
                    <div class="flex flex-col">
                        <label for="titulo" class="label">Título</label>
                        <input id="titulo" name="titulo" type="text" value="{% if row %}{{row.titulo}}{% endif %}" class="input input-bordered" required />
                    </div>
                    <div class="col-span-2 ">
                        <label class="block text-sm font-medium text-gray-700 " label="title" for="descricao">
                            Descrição
                        </label>
                        <textarea id="id_descricao"
                            rows="4"
                            class="block p-2.5 w-full shadow text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                            name="descricao"
                            placeholder="descrição"
                            required>
                        </textarea>

                        <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .editor-container { border: 1px solid #ccc; padding: 10px; }
                            button { margin-top: 10px; padding: 8px 16px; }
                        </style>

                        <!-- Container do Editor -->
                        <div id="editorjs"></div>

                    </div>
                </div>

            </div>

            <!-- Footer com botões -->
            <div class="card-footer flex flex-col gap-2 p-4 md:flex-row md:justify-end">
                <button id="btnCancelar" type="button" class="btn btn-primary w-full md:w-auto">Cancelar</button>
                <button id="btnSubmit" type="submit"class="btn btn-success w-full md:w-auto">Salvar</button>
            </div>
        </form>
        {% include 'parts/flash_message.html' %}
    </div>
</div>

{%endblock%}
{% block extra_js %}

<!-- Scripts do EditorJS -->
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest"></script>

  <script type="module">
        document.addEventListener('DOMContentLoaded', function() {
            const statusElement = document.getElementById('status');
            
            // Verificar se o EditorJS e as ferramentas estão carregados
            if (typeof EditorJS === 'undefined') {
                showStatus('Erro: EditorJS não foi carregado corretamente', 'error');
                return;
            }
            
            if (typeof Header === 'undefined') {
                showStatus('Erro: Ferramenta Header não foi carregada corretamente', 'error');
                return;
            }
            
            if (typeof List === 'undefined') {
                showStatus('Erro: Ferramenta List não foi carregada corretamente', 'error');
                return;
            }
            
            // Inicializar o EditorJS
            let editor;
            
            try {
                editor = new EditorJS({
                    holder: 'editorjs',
                    tools: {
                        header: {
                            class: Header,
                            config: {
                                placeholder: 'Digite um título...',
                                levels: [1, 2, 3, 4],
                                defaultLevel: 2
                            }
                        },
                        list: {
                            class: List,
                            inlineToolbar: true
                        }
                    },
                    placeholder: 'Comece a escrever seu conteúdo...',
                    onReady: () => {
                        showStatus('Editor carregado com sucesso!', 'success');
                    },
                    onChange: () => {
                        // Limpar status quando o usuário começar a editar
                        clearStatus();
                    }
                });
                
                showStatus('Editor inicializado com sucesso!', 'success');
            } catch (error) {
                showStatus('Erro ao inicializar o editor: ' + error.message, 'error');
                console.error(error);
                return;
            }
            
            // Elementos da UI
            const saveButton = document.getElementById('save-button');
            const clearButton = document.getElementById('clear-button');
            const outputElement = document.getElementById('output');
            
            // Salvar conteúdo
            saveButton.addEventListener('click', function() {
                editor.save().then(outputData => {
                    outputElement.textContent = JSON.stringify(outputData, null, 2);
                    showStatus('Conteúdo salvo com sucesso!', 'success');
                }).catch(error => {
                    showStatus('Erro ao salvar: ' + error.message, 'error');
                    console.log('Erro ao salvar: ', error);
                });
            });
            
            // Limpar editor
            clearButton.addEventListener('click', function() {
                editor.clear();
                outputElement.textContent = 'O conteúdo aparecerá aqui após salvar...';
                showStatus('Editor limpo com sucesso!', 'success');
            });
            
            // Adicionar conteúdo inicial de exemplo
            setTimeout(() => {
                try {
                    editor.blocks.insert('header', {
                        text: 'Bem-vindo ao EditorJS Corrigido',
                        level: 1
                    });
                    
                    editor.blocks.insert('paragraph', {
                        text: 'O erro "Uncaught ReferenceError: List is not defined" foi resolvido! Agora você pode usar todas as funcionalidades do editor.'
                    });
                    
                    editor.blocks.insert('header', {
                        text: 'Recursos do Editor',
                        level: 2
                    });
                    
                    editor.blocks.insert('list', {
                        style: 'unordered',
                        items: [
                            'Editor de blocos modular',
                            'Interface limpa e intuitiva',
                            'Suporte a diversos tipos de conteúdo',
                            'Fácil integração com Vanilla JS'
                        ]
                    });
                } catch (error) {
                    console.error('Erro ao inserir blocos iniciais:', error);
                }
            }, 1000);
            
            // Funções auxiliares para mostrar status
            function showStatus(message, type) {
                statusElement.textContent = message;
                statusElement.className = 'status ' + type;
            }
            
            function clearStatus() {
                statusElement.textContent = '';
                statusElement.className = 'status';
            }
        });
    </script>


{# acao cancelar voltar para listagem #}
<script>
    document.getElementById('btnCancelar').addEventListener('click', function () {
        window.location.href = "/chamado/chamado";
    });
</script>

{# acao criar ou atualizar #}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // Função para lidar com o evento de submit
        document.getElementById("btnSubmit").addEventListener("click", function () {
            const form = document.getElementById('form_chamado');

            if (!form.checkValidity()) {
                showMessage("Por favor, preencha todos os campos obrigatórios.", type = 'error');
                return;
            }
            
            form.submit();
        });

    });
</script>



{% endblock %}
