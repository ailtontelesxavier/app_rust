{% extends 'principal.html'%}
{% include "components/combobox.html"%}

{% block title %}Formulario de Chamado{%endblock%}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
{% endblock %}

{% block main %}
<div class="card w-full max-w-3xl shadow-lg bg-base-100">
    <div class="card-body">
        <h2 class="card-title">Formulario de Chamado</h2>

        <form id="form_chamado" class="space-y-4" method="POST" action="{% if row %}/chamado/chamado-form/{{row.id}}{% else %}/chamado/chamado-form{% endif %}"
        >
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div class="col-span-2 md:col-span-1 min-w-full">
                    {% if row %}
                    <div class="col-span-2 md:col-span-1">
                        <div class="flex flex-col min-w-full">
                            <label for="id" class="label">ID</label>
                            <input id="id" name="id" type="hidden" value="{{row.id}}" />
                            <input type="text" value="{{row.id}}" class="input input-bordered" disabled />
                            <input id="status" name="status" type="hidden" value="{{row.status}}" />
                        </div>
                    </div>
                    {% endif %}
                    <div class="flex flex-col">
                        <label class="label">
                            <span class="label-text font-semibold">Tipo</span>
                        </label>
                        {% set value_tipo = tipo.id if tipo else '' %}
                        {% set nome_tipo = tipo.nome if tipo else '' %}
                        {{ combobox(
                            field_name="tipo_id",
                            field_label="nome", 
                            placeholder="Selecione o tipo",
                            endpoint="/chamado/tipo-api",
                            attrs="required",
                            search=nome_tipo,
                            value=value_tipo,
                        ) }}
                    </div>
                    <div class="flex flex-col">
                        <label class="label">
                            <span class="label-text font-semibold">Serviço</span>
                        </label>
                        {% set value_servico = servico.id if servico else '' %}
                        {% set nome_servico = servico.nome if servico else '' %}
                        {{ combobox(
                            field_name="servico_id",
                            field_label="nome", 
                            placeholder="Selecione o serviço",
                            endpoint="/chamado/servico-api",
                            attrs="required",
                            search=nome_servico,
                            value=value_servico,
                        ) }}
                    </div>
                    <div class="flex flex-col">
                        <label for="titulo" class="label">Título</label>
                        <input id="titulo" name="titulo" type="text" value="{% if row %}{{row.titulo}}{% endif %}" class="input input-bordered" required />
                    </div>
                </div>
                {% if row %}
                <div class="col-span-2 ">
                    <label class="label-text font-semibold" for="editorjs">
                        Descrição
                    </label>

                    <div id="editorjs" class="border-1 border-gray-300 p-2"></div>
                    <!-- Campo hidden que receberá os dados do EditorJS -->
                    <input type="hidden" id="descricao" name="descricao" />
                </div>
                {% endif %}

            </div>

        </form>
        <!-- Footer com botões -->
        <div class="card-footer flex flex-col gap-2 p-4 md:flex-row md:justify-end">
            <button id="btnCancelar" type="button" class="btn btn-primary w-full md:w-auto">Cancelar</button>
            <button id="btnSubmit" type="button"class="btn btn-success w-full md:w-auto">Salvar{% if not row %} e editar{% endif %}</button>
        </div>
        {% include 'parts/flash_message.html' %}
    </div>
</div>

{%endblock%}
{% block extra_js %}

{% if row %}
<!-- Importa Editor.js direto do CDN -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>

<!-- Plugins -->
<!-- Plugins com bundle UMD -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest/dist/bundle.js"></script>
{% endif %}

<script>

    // Certifique-se de que os dados iniciais estão no formato correto
    let initialData = null;
    {% if row and row.descricao %}
    try {
        initialData = JSON.parse('{{row.descricao|safe}}');
    } catch (e) {
        console.error('Erro ao parsear dados iniciais:', e);
        initialData = {
            time: Date.now(),
            blocks: [{
                type: "paragraph",
                data: {
                    text: "Descrição do chamado..."
                }
            }],
            version: "2.26.5"
        };
    }
    {% endif %}

    {% if row %}
    const editor = new EditorJS({
        holder: 'editorjs',
        tools: {
            header: { class: Header, inlineToolbar: ['link'] },
            list: { class: List, inlineToolbar: true },
            image: {
                class: ImageTool,
                config: {
                    uploader: {
                        async uploadByFile(file) {
                            const form = new FormData();
                            form.append("image", file);
                            const res = await fetch("/chamado/chamado-upload-imagem/{{row.id}}", { method: "POST", body: form });
                            return await res.json();
                        }
                    }
                }
            }
        },
        data: initialData || {
            time: Date.now(),
            blocks: [{
                type: "paragraph",
                data: {
                    text: "Descreva o chamado aqui..."
                }
            }],
            version: "2.31.0-rc.7"
        },
    });
    {% endif %}
    //editor.blocks.stretchBlock(blockIndex, true); // antigo
    //const block = editor.blocks.getBlockByIndex(blockIndex);
    //block.stretch(true); // usando BlockAPI

    /* const editor = new EditorJS({
      holder: 'editorjs',
      tools: {
        header: {
          class: Header,
          inlineToolbar: ['link'],
          config: {
            placeholder: 'Digite um título'
          }
        },
        list: {
          class: List,
          inlineToolbar: true
        }
      }
    }); */

  </script>


{# acao cancelar voltar para listagem #}
<script>
    document.getElementById('btnCancelar').addEventListener('click', function () {
        window.location.href = "/chamado/chamado";
    });
</script>

{# acao criar ou atualizar #}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // Função para lidar com o evento de submit
        document.getElementById("btnSubmit").addEventListener("click", function () {
            const form = document.getElementById('form_chamado');

            if (!form.checkValidity()) {
                showMessage("Por favor, preencha todos os campos obrigatórios.", type = 'error');
                return;
            }
            
            // Se tiver EditorJS, salve os dados antes de submeter
            if (typeof editor !== 'undefined') {
                try {
                    // Salva os dados do EditorJS
                    const editorData = await editor.save();
                    
                    // Converte para JSON string e coloca no campo hidden
                    document.getElementById('descricao').value = JSON.stringify(editorData);
                    
                    // Agora submete o formulário
                    form.submit();
                } catch (error) {
                    showMessage("Erro ao salvar a descrição: " + error.message, 'error');
                }
            } else {
                // Se não tem EditorJS, submete normalmente
                form.submit();
            }
        });

    });
</script>



{% endblock %}
