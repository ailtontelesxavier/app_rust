{% extends 'principal.html'%}
{% include "components/combobox.html"%}

{% block title %}Formulario de Solicitação de Contato{%endblock%}

{% block main %}
<div class="card w-full min-w-3xl shadow-lg bg-base-100">
    <div class="card-body">
        <h2 class="card-title">Formulario de Solicitação de Contato</h2>

        <form id="form_contato" class="space-y-4" method="POST"
            action="{% if row %}/externo/contato-form/{{row.id}}{% else %}/externo/contato-form{% endif %}">

            <input type="hidden" name="type_contato" value="pronaf_b">

            <div class="card w-full min-w-3xl shadow-lg bg-base-100 mt-5">
                <div class="card-body">
                    <legend>DADOS DO RESPOSÁVEL POR INSERIR INFORMAÇÕES</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <fieldset class="fieldset">
                            <legend class="fieldset-legend">NOME DO TÉCNICO</legend>
                            <input id="nome_tecnico" name="nome_tecnico" type="text" value="{% if row %}{{row.nome_tecnico}}{% endif %}"
                                class="input input-bordered" />
                        </fieldset>
                        <fieldset class="fieldset">
                            <legend class="fieldset-legend">ORGÃO/ASSOCIAÇÃO</legend>
                            <input id="orgao_associacao_tecnico" name="orgao_associacao_tecnico" type="text" value="{% if row %}{{row.orgao_associacao_tecnico}}{% endif %}"
                                class="input input-bordered" />
                        </fieldset>
                        <fieldset class="fieldset">
                            <legend class="fieldset-legend">TELEFONE/WHATSAPP</legend>
                            <input id="telefone_whatsapp_tecnico" name="telefone_whatsapp_tecnico" type="text"
                                value="{% if row %}{{row.telefone_whatsapp_tecnico}}{% endif %}"
                                class="input input-bordered telefone" />
                        </fieldset>
                    </div>
                </div>
            </div>
            <legend class="block text-sm font-medium text-gray-700">
                FORMULÁRIO
            </legend>
            <input id="id" name="id" type="hidden" value="{% if row %}{{row.id}}{% endif %}"
                class="input input-bordered" />
            <div class="col-span-2 md:col-span-1 min-w-full">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">CPF</legend>
                    <input id="cpf_cnpj" name="cpf_cnpj" type="text" value="{% if row %}{{row.cpf_cnpj}}{% endif %}"
                        class="input input-bordered cpf" required />
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Nome</legend>
                    <input id="nome" name="nome" type="text" value="{% if row %}{{row.nome}}{% endif %}"
                        class="input input-bordered" required />
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Apelido</legend>
                    <input id="apelido" name="apelido" type="text"
                        value="{% if row %}{{row.apelido}}{% endif %}"
                        class="input input-bordered " />
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Estado Civil</legend>
                    <select name="estado_civil" id="estado_civil" class="select">
                        {% for estado in estado_civil %}
                        <option value="{{ estado.value }}" {% if row and estado.value==row.estado_civil %}selected{%
                            endif %}>
                            {{ estado.label }}
                        </option>
                        {% endfor %}
                    </select>
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">CEP</legend>
                    <input id="cep" name="cep" type="text" value="{% if row %}{{row.cep}}{% endif %}"
                        class="input input-bordered cep" required />
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Cidade</legend>
                    {% set value_cidade = cidade.id if cidade else '' %}
                    {% set title_cidade = cidade.title if cidade else '' %}
                    {{ combobox(
                    field_name="cidade_id",
                    field_label="nome",
                    placeholder="Selecione a cidade do Tocantins",
                    endpoint="/core/cidades-to-api",
                    attrs="required",
                    search=title_cidade,
                    value=value_cidade,
                    ) }}
                </fieldset>
            </div>
            <div class="col-span-2 md:col-span-2">
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Endereço</legend>
                    <input id="endereco" name="endereco" type="text" value="{% if row %}{{row.endereco}}{% endif %}"
                        class="input input-bordered min-w-full" required />
                </fieldset>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Telefone</legend>
                    <input id="telefone" name="telefone" type="text" value="{% if row %}{{row.telefone}}{% endif %}"
                        class="input input-bordered telefone" required />
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Email</legend>
                    <input id="email" name="email" type="text" value="{% if row %}{{row.email}}{% endif %}"
                        class="input input-bordered" required />
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Valor Solicitado</legend>
                    <input id="val_solicitado" name="val_solicitado" type="text"
                        value="{% if row %}{{row.val_solicitado|format_decimal}}{% endif %}"
                        class="input input-bordered moeda-br" required />
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Qual a previsão de aumento do faturamento com o crédito? (informar
                        em valor)
                    </legend>
                    <input id="prev_aumento_fat" name="prev_aumento_fat" type="text"
                        value="{% if row %}{{row.prev_aumento_fat|format_decimal}}{% endif %}"
                        class="input input-bordered moeda-br" required />
                </fieldset>
            </div>
            <legend class="block text-sm font-medium text-gray-700">
                Dados do Conjuge
            </legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">CPF</legend>
                    <input id="cpf_conj" name="cpf_conj" type="text" value="{% if row %}{{row.cpf_conj}}{% endif %}"
                        class="input input-bordered" />
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Nome</legend>
                    <input id="nome_conj" name="nome_conj" type="text" value="{% if row %}{{row.nome_conj}}{% endif %}"
                        class="input input-bordered" />
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Telefone</legend>
                    <input id="telefone_conj" name="telefone_conj" type="text" value="{% if row %}{{row.telefone_conj}}{% endif %}"
                        class="input input-bordered" />
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Email</legend>
                    <input id="email_conj" name="email_conj" type="text" value="{% if row %}{{row.email_conj}}{% endif %}"
                        class="input input-bordered" />
                </fieldset>
            </div>
            <legend class="block text-sm font-medium text-gray-700">
                Dados da Atividade
            </legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Valor Estimado do Imóvel</legend>
                    <input id="valor_estimado_imovel" name="valor_estimado_imovel" type="text"
                        value="{% if row %}{{row.valor_estimado_imovel|format_decimal}}{% endif %}"
                        class="input input-bordered moeda-br" />
                </fieldset>
            </div>
            <div class="col-span-2 md:col-span-2">
                <legend class="fieldset-legend">Com que Trabalha?</legend>
                <textarea id="desc_atividade" rows="4" name="desc_atividade" class="textarea min-w-full"
                    placeholder="Descrever detalhadamente..."
                    required>{% if row %}{{row.desc_atividade}}{% endif %}</textarea>

            </div>
            <div class="col-span-2 md:col-span-2">
                <legend class="fieldset-legend">Finalidade do Credito (DESCREVER O QUE PRETENDE FAZER COM O CRÉDITO)?
                </legend>
                <textarea id="finalidade_credito" rows="4" name="finalidade_credito" class="textarea min-w-full"
                    placeholder="Descrever detalhadamente..."
                    required>{% if row %}{{row.finalidade_credito}}{% endif %}</textarea>
            </div>
            <fieldset class="shadow-lg rounded-lg px-4 space-y-2 ">
                <legend class="block text-sm font-medium text-gray-700">
                    Reencher Planilha da aplicação do recurso
                </legend>
                {% if row %}
                <input id="contato_id" name="contato_id" type="hidden" value="{{row.id}}" />
                {% endif %}
                <div class="col-span-2 mt-10">
                    <fieldset class="shadow-lg rounded-lg px-4 space-y-2 ">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700 " label="title"
                                    for="id_desp_mensal_atividade">
                                    Descriçao do que vai
                                    adquirir
                                </label>
                                <input type="text" placeholder="descrição do item" id="id_descricao" name="descricao"
                                    value=""
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm ">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700 " label="title"
                                    for="id_quantidade">
                                    Quantidade
                                </label>
                                <input type="number" placeholder="" id="id_quantidade" name="quantidade" value="1"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm "
                                    min="1," step="1">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700 " label="title"
                                    for="id_valor_unitario">
                                    Valor Unitário
                                </label>
                                <input type="text" placeholder="" id="id_valor_unitario" name="valor_unitario" value="0"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm moeda-br"
                                    data-masked="true">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700 " label="title"
                                    for="id_valor_total">
                                    Valor Total
                                </label>
                                <input type="text" placeholder="" id="id_valor_total" name="valor_total" value="0"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm moeda-br"
                                    data-masked="true">
                            </div>
                        </div>
                        <div id="item-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                        <div class="col-span-2 py-2">
                            <span id="adicionar-item"
                                class="bg-gray-200 hover:bg-gray-300 inline-flex items-center justify-center bg-primary text-primary-foreground shadow hover:bg-emerald-300 h-9 px-4 py-2 cursor-pointer text-black hover:text-white rounded">
                                Adicionar Item
                            </span>
                        </div>
                    </fieldset>
                </div>
            </fieldset>
            <div class="p-6 rounded-xl shadow mt-5">
                <h2 class="text-xl font-semibold mb-2">Documentação Necessária</h2>
                <p class="text-sm text-gray-500 mb-4">Anexe todos os documentos obrigatórios listados abaixo</p>
                <p class="text-sm text-gray-500 mb-4">TODOS DOCUMENTOS DEVERÃO ESTÁ LEGÍVEIS PARA QUE POSSAM SER
                    VALIDADOS.</p>
                <p class="text-sm text-gray-500 mb-4">AS FOTOS DOS DOCUMENTOS PESSOAIS DEVERÃO DE ENVIADA FRENTE E
                    VERSO.</p>
                <div class="p-4 rounded-xl border border-blue-200">
                    <h4 class="font-medium text-blue-900 mb-1">Formatos aceitos:</h4>
                    <p class="text-sm text-blue-700">PDF, JPG, JPEG, PNG (máximo 10MB por arquivo)</p>
                </div>
                {% for doc in documentos %}
                <div data-doc class="p-4 mt-5 border rounded-lg mb-3 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium text-sm mb-1">
                                {{ loop.index }}. {{ doc.nome }}
                                {% if doc.obrigatorio %}
                                <span
                                    class="ml-2 px-2 py-0.5 bg-red-100 text-red-800 text-xs rounded">Obrigatório</span>
                                {% endif %}
                                <span id="status-{{ doc.id }}"
                                    class="ml-2 px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded hidden status-anexado">
                                    Anexado
                                </span>
                            </div>
                            <div class="text-xs text-gray-600" id="preview-{{ doc.id }}"></div>
                        </div>
                        <div>
                            <label id="label-{{ doc.id }}">
                                <input type="file" name="{{ doc.id }}" class="hidden"
                                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                    onchange="onFileChange(this, '{{ doc.id }}')" {% if doc.obrigatorio %} required {% endif %} />
                                <span
                                    class="inline-flex items-center px-3 py-1 bg-gray-100 text-sm rounded cursor-pointer hover:bg-gray-200">
                                    📎 Anexar
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <div class="p-6 rounded-xl shadow flex items-center justify-between">
                    <div class="flex items-center gap-2 text-sm text-gray-700">
                        <span id="btnCancelar"
                            class=" inline-flex items-center justify-center bg-primary text-primary-foreground shadow hover:bg-emerald-300 h-9 px-4 py-2 cursor-pointer text-black hover:text-white rounded">
                            Cancelar
                        </span>
                    </div>
                    <button id="btnSubmit" type="button"
                        class="bg-blue-600 text-white px-4 py-2 hover:cursor-pointer rounded disabled:opacity-50">
                        Finalizar
                    </button>
                </div>
            </div>
        </form>
        {% include 'parts/flash_message.html' %}
    </div>
</div>

{%endblock%}
{% block extra_js %}

<script>
    {% include '/externo/parts/contato_form_pronaf_b.js' %}
    //adicionar itens
    {% if itens %}
    let itens = {{ itens | safe }};
    {% else %}
    let itens = [];
    {% endif %}
    document.addEventListener("DOMContentLoaded", function () {

        function sincronizarInputsComArray() {
            document.querySelectorAll("#item-container input").forEach(input => {
                const name = input.name; // exemplo: "valor_total_0"
                const match = name.match(/^([a-zA-Z_]+)_(\d+)$/);
                if (match) {
                    const campo = match[1];     // ex: "valor_total"
                    const index = parseInt(match[2]); // ex: 0

                    if (!isNaN(index) && itens[index]) {
                        let valor = input.value;

                        itens[index][campo] = valor;
                    }
                }
            });
        }

        function atualizarItem(index, campo, valor) {
            if (!itens[index]) {
                itens[index] = {};
            }
            itens[index][campo] = valor;
        }

        function removerItem(index) {
            itens.splice(index, 1);
            renderizarItems();
        }

        function adicionarItem() {
            itens.push({ descricao: "", quantidade: "0", telefone: "", valor_unitario: "0", valor_total: "0" });
            renderizarItems();
        }

        function renderizarItems() {
            //matem mesmo os itens já existentes
            sincronizarInputsComArray();
            const container = document.getElementById("item-container");
            container.innerHTML = "";

            itens.forEach((item, index) => {
                const itensDiv = document.createElement("div");
                itensDiv.className = "space-y-4 p-4 rounded shadow-lg rounded-lg";

                const hiddenIdInput = item.id
                    ? `<input type="hidden" id="id_item_id${index}" name="id_${index}" value="${item.id}"/>`
                    : "";

                itensDiv.innerHTML = `
              <div class="flex items-center justify-between">
                  <label class="font-semibold">Item ${index + 1}</label>
                  <button type="button" class="text-red-500 hover:bg-gray-300 py-1 px-2 cursor-pointer remove-Item" data-index="${index}">&times;</button>
              </div>
               ${hiddenIdInput}
              
              <div class="space-y-2">
                 <label for='id_desp_mensal_atividade${index}' class="fieldset-legend">Descriçao do que vai adquirir</label>
                 <input type="text" placeholder="descrição do item" id="id_descricao${index}" name="descricao_${index}" value="${item.descricao}" class="mt-1 block w-full px-3 py-2 border border-gray-300 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm ">
            </div>
            <div class="space-y-2">
                 <label for='id_quantidade${index}' class="fieldset-legend">Quantidade</label>
                <input type="number" placeholder="" id="id_quantidade${index}" name="quantidade_${index}" value="${item.quantidade}" class="mt-1 block w-full px-3 py-2 border border-gray-300 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm " min="1," step="1">
            </div>
            <div class="space-y-2">
                <label for='id_valor_unitario${index}' class="fieldset-legend">Valor Unitário</label>
               <input type="text" placeholder="" id="id_valor_unitario${index}" name="valor_unitario_${index}" value="${Number.parseFloat(item.valor_unitario).toFixed(2)}" class="moeda-br mt-1 block w-full px-3 py-2 border border-gray-300 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm " min="0," step="0.01">
            </div>
            <div class="space-y-2">
                <label for='id_valor_total${index}' class="fieldset-legend">Valor Total</label>
                <input type="text" placeholder="" id="id_valor_total${index}" name="valor_total_${index}" value="${Number.parseFloat(item.valor_total).toFixed(2)}" class="moeda-br mt-1 block w-full px-3 py-2 border border-gray-300 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm " min="0," step="0.01">
            </div>

          `;

                container.appendChild(itensDiv);
                aplicarMascaraMoedaBRL();
            });

            // Adicionar eventos de input dinâmico
            document.querySelectorAll("input, select").forEach(element => {
                element.addEventListener("input", function () {
                    const index = this.getAttribute("data-index");
                    const campo = this.getAttribute("data-field");
                    const valor = this.type === "checkbox" ? this.checked : this.value;
                    atualizarItem(index, campo, valor);
                });

                // Adicionar evento change para o select de estado civil
                if (element.tagName.toLowerCase() === 'select') {
                    element.addEventListener("change", function () {
                        const index = this.getAttribute("data-index");
                        const campo = this.getAttribute("data-field");
                        const valor = this.value;
                        atualizarItem(index, campo, '' + valor);
                        //renderizarItems();
                    });
                }
            });

            // Adicionar eventos de remoção
            document.querySelectorAll(".remove-Item").forEach(button => {
                button.addEventListener("click", function () {
                    const index = parseInt(this.getAttribute("data-index"));
                    removerItem(index);
                });
            });
        }

        document.getElementById("adicionar-item").addEventListener("click", adicionarItem);

        // Renderizar ao iniciar
        renderizarItems();

    });
</script>

{# documentos #}
 <script>
    function onFileChange(input, id) {
      const file = input.files[0]
      const status = document.getElementById("status-" + id)
      const label = document.getElementById("label-" + id)
      const preview = document.getElementById("preview-" + id)

      if (file) {
        //label.classList.add("hidden")
        preview.innerText = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`
        //status.classList.remove("hidden")
      } else {
        label.classList.remove("hidden")
        preview.innerText = ""
        status.classList.add("hidden")
      }

    }
</script>


{% endblock %}